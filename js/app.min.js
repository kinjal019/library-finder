
var Library=function(){this.name=ko.observable();this.id=ko.observable();this.lat=ko.observable();this.lng=ko.observable();this.address=ko.observable();this.rating=ko.observable();this.ratingColor=ko.observable();this.usersCount=ko.observable();this.contact=ko.observable();this.status=ko.observable();this.url=ko.observable();this.mapMarker=ko.observable();this.markerInfoWindow=ko.observable();};function AppViewModel(){var self=this;var map,autocomplete,bounds;self.libraries=ko.observableArray();self.currentSuggestedBounds=ko.observable();self.currentTab=ko.observable('all');self.currentPlace=ko.observable();self.inSearch=ko.observable(false);self.searchAll=function(){self.currentTab('all');if(self.isCurrentPlaceAvailable()){self.searchLibraries();}else{self.showNoPlaceFoundPopover();}};self.searchOpen=function(){self.currentTab('open');if(self.isCurrentPlaceAvailable()){self.searchLibraries();}else{self.showNoPlaceFoundPopover();}};self.searchTop=function(){self.currentTab('top');if(self.isCurrentPlaceAvailable()){self.searchLibraries();}else{self.showNoPlaceFoundPopover(true);}};self.initMap=function(){var initLocation={lat:41.0417,lng:29.0094};map=new google.maps.Map(document.getElementById('map'),{center:initLocation,disableDefaultUI:false,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},scrollwheel:true,zoom:12});}();self.clearLibraries=function(){$.each(self.libraries(),function(index,library){library().mapMarker().setMap(null);});self.libraries.removeAll();};self.addMarkerWithDelay=function(library,rate,delay){window.setTimeout(function(){var icon;if(self.currentTab()==='top'){icon='img/markers/marker'+rate+'.png';}else{icon='img/markers/marker.png';}
var marker=new google.maps.Marker({map:map,draggable:false,title:library().name(),animation:google.maps.Animation.DROP,icon:icon,position:{lat:library().lat(),lng:library().lng()}});var infowindow=new google.maps.InfoWindow({content:self.generateInfoString(library),maxWidth:280});google.maps.event.addListener(infowindow,'closeclick',function(){marker.setAnimation(null);});library().markerInfoWindow(infowindow);marker.addListener('click',function(){marker.setAnimation(google.maps.Animation.BOUNCE);infowindow.open(map,marker);});library().mapMarker(marker);},delay);};self.stopMarkersAnimation=function(){$.each(self.libraries(),function(index,library){library().mapMarker().setAnimation(null);});};self.closeAllMarkersInfoWindows=function(){$.each(self.libraries(),function(index,library){library().markerInfoWindow().close(map,library().mapMarker());});};self.resizeMapToSuggestedBounds=function(){var bounds=new google.maps.LatLngBounds();var ne=self.currentSuggestedBounds().ne;var sw=self.currentSuggestedBounds().sw;bounds.extend(new google.maps.LatLng(ne.lat,ne.lng));bounds.extend(new google.maps.LatLng(sw.lat,sw.lng));map.fitBounds(bounds);};self.generateInfoString=function(library){var info=info_name.replace('%name%',library().name());if(library().status()!==undefined&&library().status()!==null){info+=info_status.replace('%status%',library().status());}
if(library().address()!==undefined&&library().address()!==null){info+=info_address.replace('%address%',library().address());}
if(library().rating()!==undefined&&library().rating()!==null){info+=info_rating.replace('%rating%',library().rating()).replace('%color%',library().ratingColor()).replace('%users%',library().usersCount());}
var contact=$(info_contact);if(library().url()!==undefined&&library().url()!==null){contact.append(info_url.replace('%url%',library().url()));}
if(library().contact().phone!==undefined&&library().contact().phone!==null){contact.append(info_phone.replace('%phone%',library().contact().phone));}
if(library().contact().facebook!==undefined&&library().contact().facebook!==null){contact.append(info_facebook.replace('%id%',library().contact().facebook));}
if(library().contact().twitter!==undefined&&library().contact().twitter!==null){contact.append(info_twitter.replace('%name%',library().contact().twitter));}
contact.append(info_foursquare.replace('%id%',library().id()));var container=$(info_contact_container);container.append(contact);return info+container.html();};self.getPlaceFromInput=function(){if(!self.inSearch()){self.clearLibraries();self.clearTable();self.currentPlace(self.autocomplete.getPlace());if(self.currentPlace().geometry){self.searchLibraries();}else{self.showNoPlaceFoundPopover();}}};self.initSearch=function(){var input=document.getElementById('input');var searchBox=new google.maps.places.SearchBox(input);self.autocomplete=new google.maps.places.Autocomplete(input);self.autocomplete.addListener('place_changed',self.getPlaceFromInput);}();this.foursquareConstants={clientId:'05KBIJ3CKDQQUEQF14CJGLDP3D3P0X1ZIDL0AG5XHMKIX5AY',clientSecret:'GO4A1C0E1SI1RVFG20BT03D2YPITDSCTDMNPRDGYMAYLYJ4Y',baseURL:'https://api.foursquare.com/v2/',method:'venues/explore',categories:{library:'4bf58dd8d48988d12f941735',collegeLibrary:'4bf58dd8d48988d1a7941735'},limit:100,animationDelay:50};self.searchLibraries=function(){self.clearLibraries();self.clearTable();self.inSearch(true);self.setTabLoading(true);if(self.currentPlace().geometry===null||self.currentPlace().geometry===undefined){return;}else if(self.currentPlace().geometry.location===null||self.currentPlace().geometry.location===undefined){return;}
var location=self.currentPlace().geometry.location;var ajaxData={client_id:self.foursquareConstants.clientId,client_secret:self.foursquareConstants.clientSecret,v:'20160230',query:'library',ll:location.lat()+','+location.lng(),limit:self.foursquareConstants.limit,sort:'popular',categoryId:[self.foursquareConstants.categories.library,self.foursquareConstants.categories.collegeLibrary]};if(self.currentTab()==='open'){ajaxData.openNow=true;}else if(self.currentTab()==='top'){ajaxData.limit=10;}
$.ajax({url:self.foursquareConstants.baseURL+self.foursquareConstants.method,type:'GET',dataType:'json',data:ajaxData,timeout:7000,success:function(data){if(data.response.totalResults<1){var message;if(self.currentTab()==='open'){message='No libraries is open now near '+self.currentPlace().name;}else{message='No libraries found near '+self.currentPlace().name;}
self.inSearch(false);self.setTabLoading(false);alert(message);return;}
self.currentSuggestedBounds(data.response.suggestedBounds);self.resizeMapToSuggestedBounds();var items=data.response.groups[0].items;$.each(items,function(index,item){var venue=item.venue;var library=ko.observable(new Library());library().name(venue.name);library().id(venue.id);library().lat(venue.location.lat);library().lng(venue.location.lng);library().address(venue.location.address);library().rating(venue.rating);library().ratingColor(venue.ratingColor);library().contact(venue.contact);library().url(venue.url);library().usersCount(venue.stats.usersCount);if(venue.hours!==undefined&&venue.hours!==null){library().status(venue.hours.status);}
if(self.currentTab()=='top'){self.addMarkerWithDelay(library,(index+1).toString(),index*self.foursquareConstants.animationDelay);}else{self.addMarkerWithDelay(library,"",index*self.foursquareConstants.animationDelay);}
setTimeout(function(){self.inSearch(false);self.setTabLoading(false);self.hideNavBar();},items.length*self.foursquareConstants.animationDelay);self.addLibraryToTable(library);setTimeout(function(){self.libraries.push(library);},index*self.foursquareConstants.animationDelay);});},fail:function(error){self.inSearch(false);self.setTabLoading(false);self.hideNavBar();console.log(error);},error:function(error){self.inSearch(false);self.setTabLoading(false);self.hideNavBar();var errorString;if(error.status===0){errorString="the request timed out please try again.";}else{errorString=error.statusText;}
alert(errorString);}});};self.addLibraryToTable=function(library){var $tr=$('<tr>');var $td=$('<td>');$td.append(table_name.replace('%name%',library().name()));if(library().address()!==undefined&&library().address()!==null){$td.append(table_address.replace('%address%',library().address()));}
if(library().status()!==undefined&&library().status()!==null){$td.append(table_status.replace('%status%',library().status()));}
if(library().rating()!==undefined&&library().rating()!==null){$td.append(table_rating.replace('%rating%',library().rating()).replace('%color%',library().ratingColor()).replace('%users%',library().usersCount()));}
$td.click(function(event){self.stopMarkersAnimation();library().mapMarker().setAnimation(google.maps.Animation.BOUNCE);map.setCenter(new google.maps.LatLng(library().mapMarker().position.lat(),library().mapMarker().position.lng()));map.setZoom(16);self.closeAllMarkersInfoWindows();library().markerInfoWindow().open(map,library().mapMarker());if($(window).width()<768){self.toggleTable();}});$tr.append($td);$('#table').append($tr);};self.clearTable=function(){$('#table').find("tr:gt(0)").remove();};self.searchTable=function(searchString){self.clearTable();$.each(self.libraries(),function(index,library){var lowerString=searchString.toLowerCase();var lowerName=library().name().toLowerCase();if(self.wordInString(lowerName,lowerString)){self.addLibraryToTable(library);}});};self.toggleTable=function(){$('.table-container').toggle('drop');$('#table-button').toggleText('<span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span> Hide List','<span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span> Show List');};self.showNoPlaceFoundPopover=function(){$('#input').popover('show');setTimeout(function(){$('#input').popover('destroy');},2000);};self.wordInString=function(s,word){return new RegExp(word,'i').test(s);};self.isCurrentPlaceAvailable=function(){if(self.currentPlace()===null||self.currentPlace()===undefined){return false;}else if(self.currentPlace().geometry===null||self.currentPlace().geometry===undefined){return false;}else if(self.currentPlace().geometry.location===null||self.currentPlace().geometry.location===undefined){return false;}
return true;};self.setTabLoading=function(loading){if(loading){if(self.currentTab()==='all'){$('#all-button').prepend('<i class="fa fa-circle-o-notch fa-spin"></i>');}
if(self.currentTab()==='open'){$('#open-button').prepend('<i class="fa fa-circle-o-notch fa-spin"></i>');}
if(self.currentTab()==='top'){$('#top-button').prepend('<i class="fa fa-circle-o-notch fa-spin"></i>');}}else{$('i.fa-spin').remove();}};self.hideNavBar=function(){if($('.navbar-collapse').hasClass("in")){$('.navbar-toggle').click();}};$('input').addClear();$('#table-button').click(function(event){$('#table-button').toggleClass('active');if(self.libraries().length>0){self.toggleTable();if($(window).width()>=768){if(self.currentSuggestedBounds()!==null&&self.currentSuggestedBounds()!==undefined){self.resizeMapToSuggestedBounds();}
self.closeAllMarkersInfoWindows();self.stopMarkersAnimation();}}else{$('#table-button').popover('show');setTimeout(function(){$('#table-button').popover('destroy');},2000);}});$('.table-container').hide();$('.table-container').removeClass('hidden');$('#map').click(function(event){var clickover=$(event.target);var $navbar=$(".navbar-collapse");var _opened=$navbar.hasClass("in");if(_opened===true&&!clickover.hasClass("navbar-toggle")){$navbar.collapse('hide');}});$('.table-input').on('input',function(){self.searchTable($('.table-input').val());});}
ko.applyBindings(new AppViewModel());