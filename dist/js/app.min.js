
var info_name='<h4 class="info_name">%verified_icon% %name% %verified%</h4>';var info_address='<p class"info-p"> <i class="fa fa-map-marker"></i>  %address%</p>';var info_status='<p class"info-p"><i class="fa fa-clock-o"></i>  %status%</p>';var info_rating='<p info-p><i class="fa fa-star"></i> Rated: <strong style="color:%color%;">%rating% / 10</strong> by %users% visitors</p>';var info_contact='<ul class="info_contact"><li> Contact: <li></ul>';var info_contact_container='<div></div>';var info_url='<li><a href="%url%" target="_blank"><i class="fa fa-external-link fa-2x"></i></a></li>';var info_phone='<li><a href="tel:%phone%"><i class="fa fa-phone fa-2x"></i></a></li>';var info_facebook='<li><a href="https://www.facebook.com/%id%" target="_blank"><i class="fa fa-facebook fa-2x"></i></a></li>';var info_twitter='<li><a href="https://twitter.com/%name%" target="_blank"><i class="fa fa-twitter fa-2x"></i></a></li>';var info_foursquare='<li><a href="https://foursquare.com/v/%id%" target="_blank"><i class="fa fa-foursquare fa-2x"></i></a></li>';$.fn.extend({toggleText:function(a,b){if(this.html()==a){this.html(b);}else{this.html(a);}}});$('#map').click(function(event){var clickover=$(event.target);var $navbar=$(".navbar-collapse");var _opened=$navbar.hasClass("in");if(_opened===true&&!clickover.hasClass("navbar-toggle")){$navbar.collapse('hide');}});var hideNavBar=function(){if($('.navbar-collapse').hasClass("in")){$('.navbar-toggle').click();}};var toggleTable=function(){$('.table-container').toggle('drop');$('#table-button').toggleText('<span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span> Hide List','<span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span> Show List');};$('input').addClear();$('.table-container').hide();$('.table-container').removeClass('hidden');var showNoPlaceFoundPopover=function(){$('#input').popover('show');setTimeout(function(){$('#input').popover('destroy');},2000);};var Library=function(){this.name=ko.observable();this.id=ko.observable();this.lat=ko.observable();this.lng=ko.observable();this.address=ko.observable();this.rating=ko.observable();this.ratingColor=ko.observable();this.usersCount=ko.observable();this.contact=ko.observable();this.verified=ko.observable();this.status=ko.observable();this.url=ko.observable();this.mapMarker=ko.observable();};var foursquareConstants={clientId:'05KBIJ3CKDQQUEQF14CJGLDP3D3P0X1ZIDL0AG5XHMKIX5AY',clientSecret:'GO4A1C0E1SI1RVFG20BT03D2YPITDSCTDMNPRDGYMAYLYJ4Y',baseURL:'https://api.foursquare.com/v2/',method:'venues/explore',categories:{library:'4bf58dd8d48988d12f941735',collegeLibrary:'4bf58dd8d48988d1a7941735'},limit:100,searchTimeOut:7000};var searchForLibrariesNearLocation=function(location,type,success,error){var ajaxData={client_id:foursquareConstants.clientId,client_secret:foursquareConstants.clientSecret,v:'20160230',query:'library',ll:location.lat+','+location.lng,limit:foursquareConstants.limit,sort:'popular',categoryId:[foursquareConstants.categories.library,foursquareConstants.categories.collegeLibrary]};if(type==='open'){ajaxData.openNow=true;}else if(type==='top'){ajaxData.limit=10;}
$.ajax({url:foursquareConstants.baseURL+foursquareConstants.method,type:'GET',dataType:'json',data:ajaxData,timeout:foursquareConstants.searchTimeOut,success:success,error:error});};var createLibraryFromItem=function(item){var venue=item.venue;var library=ko.observable(new Library());library().name(venue.name);library().id(venue.id);library().lat(venue.location.lat);library().lng(venue.location.lng);library().address(venue.location.address);library().verified(item.venue.verified);library().rating(venue.rating);library().ratingColor('#'+venue.ratingColor);library().contact(venue.contact);library().url(venue.url);library().usersCount(venue.stats.usersCount);if(venue.hours!==undefined&&venue.hours!==null){library().status(venue.hours.status);}
return library;};var map,autocomplete;var infowindow;var setCurrentLocation=function(success,error){var options={enableHighAccuracy:true,timeout:5000,maximumAge:0};navigator.geolocation.getCurrentPosition(success,error,options);};var setMap=function(location,mapReady){if(typeof google==='undefined'){$('#map').remove();$('#table-button').remove();$('li').addClass('disabled');$('input').prop('disabled',true);$('body').append('<h3 class="error">Google Maps not available!, try again later.</h3>');console.log('not available');return;}else{infowindow=new google.maps.InfoWindow();map=new google.maps.Map(document.getElementById('map'),{center:location,disableDefaultUI:false,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},scrollwheel:true,zoom:12});var input=document.getElementById('input');var searchBox=new google.maps.places.SearchBox(input);autocomplete=new google.maps.places.Autocomplete(input);google.maps.event.addListenerOnce(map,'idle',mapReady);}};var resizeMapToBounds=function(bounds,mapReady){var bnds=new google.maps.LatLngBounds();var ne=bounds.ne;var sw=bounds.sw;bnds.extend(new google.maps.LatLng(ne.lat,ne.lng));bnds.extend(new google.maps.LatLng(sw.lat,sw.lng));map.fitBounds(bnds);google.maps.event.addListenerOnce(map,'idle',mapReady);window.onresize=function(){map.fitBounds(bnds);};};var creatMarker=function(library,currentTab,rate){var icon;if(currentTab==='top'){icon='img/markers/marker'+rate+'.png';}else{if(library.verified()){icon='img/markers/marker_ver.png';}else{icon='img/markers/marker.png';}}
var marker=new google.maps.Marker({map:map,draggable:false,title:library.name(),animation:google.maps.Animation.DROP,icon:icon,position:{lat:library.lat(),lng:library.lng()}});marker.addListener('click',function(){animateAllMarkers(null);marker.setAnimation(google.maps.Animation.BOUNCE);infowindow.close();infowindow=createInfowindowForLibrary(library);google.maps.event.addListener(infowindow,"closeclick",function(){animateAllMarkers(null);});infowindow.open(map,marker);});library.mapMarker(marker);};var animateAllMarkers=function(animation){$.each(appVM.libraries(),function(index,library){if(animation==='bounce'){library().mapMarker().setAnimation(google.maps.Animation.BOUNCE);}else if(animation==='drop'){library().mapMarker().setAnimation(google.maps.Animation.DROP);}else{library().mapMarker().setAnimation(null);}});};var createInfowindowForLibrary=function(library){var infowindow=new google.maps.InfoWindow({content:generateInfoWindowContent(library),maxWidth:280});return infowindow;};var generateInfoWindowContent=function(library){var info=library.verified()?info_name.replace('%name%',library.name()).replace('%verified_icon%','<i class="fa fa-certificate"></i>').replace('%verified%','(verified)'):info_name.replace('%name%',library.name()).replace('%verified_icon%','').replace('%verified%','');if(library.status()){info+=info_status.replace('%status%',library.status());}
if(library.address()){info+=info_address.replace('%address%',library.address());}
if(library.rating()){info+=info_rating.replace('%rating%',library.rating()).replace('%color%',library.ratingColor()).replace('%users%',library.usersCount());}
var contact=$(info_contact);if(library.url()){contact.append(info_url.replace('%url%',library.url()));}
if(library.contact().phone){contact.append(info_phone.replace('%phone%',library.contact().phone));}
if(library.contact().facebook){contact.append(info_facebook.replace('%id%',library.contact().facebook));}
if(library.contact().twitter){contact.append(info_twitter.replace('%name%',library.contact().twitter));}
contact.append(info_foursquare.replace('%id%',library.id()));var container=$(info_contact_container);container.append(contact);return info+container.html();};var isPlaceValid=function(place){if(place===null||place===undefined){return false;}else if(place.geometry===null||place.geometry===undefined){return false;}else if(place.geometry.location===null||place.geometry.location===undefined){return false;}
return true;};var AppViewModel=function(){var self=this;self.libraries=ko.observableArray();self.filteredLibraries=ko.observableArray();self.currentLocation=ko.observable();self.currentSuggestedBounds=ko.observable();self.currentTab=ko.observable('all');self.inSearch=ko.observable(false);self.query=ko.observable('');self.searchAll=function(){self.currentTab('all');self.searchLibraries();};self.searchOpen=function(){self.currentTab('open');self.searchLibraries();};self.searchTop=function(){self.currentTab('top');self.searchLibraries();};self.search=function(value){self.filteredLibraries.removeAll();for(var i in self.libraries()){if(self.libraries()[i]().name().toLowerCase().indexOf(value.toLowerCase())>=0){self.filteredLibraries.push(self.libraries()[i]);}}};setCurrentLocation(function(pos){var crd=pos.coords;self.currentLocation({lat:crd.latitude,lng:crd.longitude});setMap(self.currentLocation(),function(){autocomplete.addListener('place_changed',function(){var place=autocomplete.getPlace();if(isPlaceValid(place)){var loc={lat:place.geometry.location.lat(),lng:place.geometry.location.lng(),};self.currentLocation(loc);self.searchLibraries();}else{showNoPlaceFoundPopover();}});self.searchLibraries();});},function(err){console.warn('ERROR('+err.code+'): '+err.message);self.currentLocation({lat:41.0417,lng:29.0094});setMap(self.currentLocation(),function(){autocomplete.addListener('place_changed',function(){var place=autocomplete.getPlace();if(isPlaceValid(place)){var loc={lat:place.geometry.location.lat(),lng:place.geometry.location.lng(),};self.currentLocation(loc);self.searchLibraries();}else{showNoPlaceFoundPopover();}});self.searchLibraries();});});self.searchLibraries=function(){self.inSearch(true);$.each(self.libraries(),function(index,library){library().mapMarker().setMap(null);});self.libraries.removeAll();self.filteredLibraries.removeAll();searchForLibrariesNearLocation(self.currentLocation(),self.currentTab(),function(data){var items=data.response.groups[0].items;if(items.length<1){self.inSearch(false);if(self.currentTab()==='open'){alert("No open libraries now!, please try again later.");}else{alert("No Libraries found!");}
return;}
var suggestedBounds=data.response.suggestedBounds;self.currentSuggestedBounds(suggestedBounds);resizeMapToBounds(self.currentSuggestedBounds(),function(){var totalDelay=items.length*50;$.each(items,function(index,item){var library=createLibraryFromItem(item);var delay=index*50;setTimeout(function(){if(self.currentTab()==='top'){creatMarker(library(),self.currentTab(),index+1);}else{creatMarker(library(),self.currentTab(),null);}
self.libraries.push(library);self.filteredLibraries.push(library);},delay);});setTimeout(function(){self.inSearch(false);if($(window).width()<768){hideNavBar();}},totalDelay);});},function(error){var errorString;if(error.status===0){errorString="the request timed out please try again.";}else{errorString=error.statusText;}
console.warn('Foursquare: '+errorString);alert(errorString);});};self.showLibrary=function(library){if($(window).width()<768){toggleTable();}
animateAllMarkers(null);infowindow.close();library.mapMarker().setAnimation(google.maps.Animation.BOUNCE);infowindow=createInfowindowForLibrary(library);google.maps.event.addListener(infowindow,"closeclick",function(){animateAllMarkers(null);if($(window).width()<768){resizeMapToBounds(self.currentSuggestedBounds(),function(){});}});var latLng=library.mapMarker().getPosition();map.setCenter(latLng);google.maps.event.addListenerOnce(map,'idle',function(){infowindow.open(map,library.mapMarker());});};};var appVM=new AppViewModel();appVM.query.subscribe(appVM.search);ko.applyBindings(appVM);